name: Build

on:
  push:
    branches:
      - master
      - branch-*
      - dogfood-*
  pull_request:
  merge_group:
  workflow_dispatch:

# Workflow-level concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref_name != github.event.repository.default_branch }}

# Required permissions for Vault OIDC and repo operations
permissions:
  id-token: write
  contents: write

jobs:
  build:
    runs-on: sonar-s-public  # Public repository runner
    name: Build
    outputs:
      PROJECT_VERSION: ${{ steps.build-step.outputs.project-version }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - id: build-step
        uses: SonarSource/ci-github-actions/build-gradle@v1
        with:
          deploy-pull-request: true
          artifactory-reader-role: private-reader
          artifactory-deployer-role: qa-deployer
          sonar-platform: sqc-eu
          gradle-args: :cyclonedxBom jacocoTestReport
          use-develocity: true

  integration:
    needs: [build]
    runs-on: github-ubuntu-latest-m
    name: IT - ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: STDIO
            test_class: StdioTransportITest
          - name: HTTP
            test_class: HttpTransportITest
          - name: ProxiedServer
            test_class: ProxiedServerITest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          version: 2025.7.12

      - name: Vault (SonarCloud IT token)
        id: secrets-sc
        uses: SonarSource/vault-action-wrapper@320bd31b03e5dacaac6be51bbbb15adf7caccc32 # v3.1.0
        with:
          secrets: |
            development/team/sonarlint/kv/data/sonarcloud-it token | SONARCLOUD_IT_TOKEN;
            development/kv/data/repox url | ARTIFACTORY_URL;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader username | ARTIFACTORY_USER;
            development/artifactory/token/{REPO_OWNER_NAME_DASH}-private-reader access_token | ARTIFACTORY_ACCESS_TOKEN;

      - name: Download plugin from Artifactory
        env:
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_PRIVATE_USERNAME: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_PRIVATE_PASSWORD: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          PROJECT_VERSION: ${{ needs.build.outputs.PROJECT_VERSION }}
        run: |
          set -euo pipefail
          echo "Using project version: ${PROJECT_VERSION}"
          DOWNLOAD_URL="${ARTIFACTORY_URL}/sonarsource-public-qa/org/sonarsource/sonarqube/mcp/server/sonarqube-mcp-server/${PROJECT_VERSION}/sonarqube-mcp-server-${PROJECT_VERSION}.jar"
          
          # Retry logic to handle Artifactory propagation delays
          MAX_ATTEMPTS=2
          RETRY_DELAY=5
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "Download attempt $attempt of $MAX_ATTEMPTS..."
            if curl -fsSL -u "${ARTIFACTORY_PRIVATE_USERNAME}:${ARTIFACTORY_PRIVATE_PASSWORD}" \
              -o sonarqube-mcp-server.jar \
              "${DOWNLOAD_URL}"; then
              echo "Download successful"
              break
            fi
            if [ $attempt -eq $MAX_ATTEMPTS ]; then
              echo "All download attempts failed"
              exit 1
            fi
            echo "Download failed, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done
          
          mkdir -p ${GITHUB_WORKSPACE}/downloaded-plugin
          mv sonarqube-mcp-server.jar ${GITHUB_WORKSPACE}/downloaded-plugin/

      - name: Run Integration Tests
        env:
          SONARCLOUD_IT_TOKEN: ${{ steps.secrets-sc.outputs.vault && fromJSON(steps.secrets-sc.outputs.vault).SONARCLOUD_IT_TOKEN || '' }}
          ARTIFACTORY_URL: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_URL }}
          ARTIFACTORY_USER: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_USER }}
          ARTIFACTORY_ACCESS_TOKEN: ${{ fromJSON(steps.secrets-sc.outputs.vault).ARTIFACTORY_ACCESS_TOKEN }}
          DOWNLOADED_JAR_PATH: ${{ github.workspace }}/downloaded-plugin/sonarqube-mcp-server.jar
        run: |
          ./gradlew :its:integrationTest --tests "*${{ matrix.test_class }}" --info

  promote:
    needs: [build]
    runs-on: github-ubuntu-latest-s  # Public repository runner
    name: Promote
    steps:
      - uses: SonarSource/ci-github-actions/promote@v1
        with:
          promote-pull-request: true
